# Layer2介绍大纲

## 背景介绍

### 区块链扩容

​	区块链去中心化的特性，使得存储和计算性能受限，需要进行扩容

1. 交易确认慢
2. GAS费用高

### 扩容分类

- Layer1扩容，又称链上扩容（On-chain），对区块链本身的性能提升
  - 修改共识算法：中心化换性能，代表Avalanche、Solana。
  - Sharding：分库分表、并行计算，代表ETH2.0、Near。
- Layer2扩容，又称链下扩容（Off-chain），链下计算，结果上链

## Layer2扩容方案

### 扩容思路：

​	主要在于如何保证“状态有效” --State Validity（SV）和“数据可用”--Data Availablility（DA）

- 保证SV，即防止Layer2的无效的状态回传到主链
  - ZK Proof
  - Fraud Proof
  - PoA多签
  - Light Cilent
- 保证DA，即保证Layer2 state的持久化，防止Layer2停止维护数据丢失导致资产锁死
  - 存去中心化的Layer1
  - 存中心化的Layer2

### 主要技术

#### State Channels（状态通道）

- 原理
- 如何保证SV&DA
- 主要项目
- 安全、性能、兼容性分析

#### Sidechain（侧链）

- 原理
- 如何保证SV&DA
- 主要项目
- 安全、性能、兼容性分析

#### Plasma/Childchain

- 原理
- 如何保证SV&DA
- 主要项目
- 安全、性能、兼容性分析

#### Validium

- 原理
- 如何保证SV&DA
- 主要项目
- 安全、性能、兼容性分析

#### Rollup

- 原理
- 如何保证SV&DA
- 主要项目
- 安全、性能、兼容性分析

### 优势和挑战

​	  **优势**

- 提高可扩展性

-  降低交易费用

-  加快交易速度

  **挑战：**

- 安全性与去中心化问题
- 跨链互操作性

### 未来发展趋势

- 与Layer1的融合
- 准化与协议互操作性
- Layer2的商业模式与应用生态

# 侧链

## 简介

### 产生背景

​		侧链技术概念源于**比特币性能提升困境与数字货竞争**。早在2012年，在比特币聊天室中，就出现了关于侧链概念的相关讨论。当时的比特币的核心开发团队正在考虑如何可以安全的升级比特币协议，以增加新的功能，但是直接在比特币区块链上进行功能添加比较危险，因为如果新功能在实践中发生软件故障，则会对现有的比特币网络造成严重影响。

​		另外，由于比特币的网络结构特性，如果进行较大规模的改动，还需要获得多数比特币矿工的支持。这时，比特币核心开发者便提出了侧链方案。这种技术允许开发人员将新功能附加在其他的区块链，但是这些区块链仍然附着在现有比特币区块链上。这些区块链中新功能可以充分利用现有比特币的网络特性，而不会对现有的比特币网络造成危害。

​		侧链的进一步发展是在**2014**年，为了将侧链由概念转化成现实，Adam Back、Matt Corallo等比特币核心开发者共同发起成立了**Blockstream**公司，并在同年十月，发布了白皮书**《Enabling Blockchain Innovations with Pegged Sidechains》**，首次明确提出了侧链的概念及其协议实现方案。

​		通过侧链，可以在主链的基础上，进行交易隐私保护技术、智能合约等新功能的添加，这样可以让用户访问大量的新型服务，并且对现有主链的工作并不造成影响。另外，侧链也提供了一种更安全的协议升级方式，当侧链发生灾难性的问题时，主链依然安然无恙。

### 概念

​		侧链的提出本质上是为了解决主链的可扩展性问题，为区块链技术的应用和实验提供更大的发展空间。侧链是一条相对独立的区块链，可以设计和选择自己的共识机制，其性能和安全性也由项目方的架构设计去决定，而不是依赖主链。正是由于主链和侧链有着不同的设计和规则，在这两者之间进行数字资产的转移是困难的，因此侧链协议提供了一种桥接机制，通过在主链上锁定一定数量的数字资产，然后在侧链上生成对应的代币，实现数字资产的跨链转移，同时也支持实现将数字资产从侧链安全地返回到主链。		

## 实现方案

​		侧链实现的技术基础是双向锚定（Two-way Peg），通过双向锚定技术，可以实现暂时的将数字资产在主链中锁定，同时将等价的数字资产在侧链中释放，同样当等价的数字资产在侧链中被锁定的时候，主链的数字资产也可以被释放。其实现技术有以下几种：

- **单一托管模式**

  ​		在单一托管模式中，一个中心化的实体（例如银行或第三方）扮演着侧链网络的托管人。该实体负责处理主链和侧链之间的交互，并保持主链与侧链之间的一致性。主链向侧链锁定资产时，中心化实体会持有这些资产，同时在侧链上颁发与其等价的代币供用户在侧链上使用。当用户在侧链上完成交易后，中心化实体会收回代币，并将解锁的资产返还给用户。这种模式的优势是简单易于实现，但存在对中心化实体的信任依赖。

  ![img](https://gitee.com/kkostar/pic/raw/master/pwt3eefu7c.jpeg)

- **联盟模式**

  ​		在联盟模式中，多个实体共同管理侧链网络，形成一个联盟。这些实体可以是银行、企业或其他机构。联盟中的实体通过合作共同管理侧链，包括验证交易、共识机制的决策等。这种模式的优势是减少了对单个中心化实体的依赖，提高了安全性和可信度。

  ![img](https://gitee.com/kkostar/pic/raw/master/mj5s1nqvcw.jpeg)

- **SPV模式**

  ​		在SPV模式中，侧链通过主链的验证节点进行验证。用户只需要关注主链的区块头信息，并从中获取侧链的验证信息。用户不需要完全下载整个侧链的区块数据，只需验证区块头信息以确保交易在侧链上得到确认。这种模式的优势是提高了侧链的可扩展性和服务效率，但减少了对侧链的安全性要求。

  ![img](https://gitee.com/kkostar/pic/raw/master/tm103nzlxb.jpeg)

- **驱动链模式**

  ​		在驱动链中，矿工作为"算法代理监护人"，对侧链当前的状态进行检测。驱动链将被锁定数字资产的监管权发放到数字资产矿工手上，并且允许矿工们投票何时解锁数字资产和将解锁的数字资产发送到何处。矿工观察侧链的状态，当他们收到来自侧链的要求时，他们会执行协调协议以确保他们对要求的真实性达成一致。这种模式的优势是主链的安全性和稳定性对侧链的运行至关重要，同时用户可以从主链向侧链转移资产，实现主链与侧链之间的互操作。

  ![img](https://gitee.com/kkostar/pic/raw/master/japrfxid1s.jpeg)

- **混合模式**

​		混合模式结合了上述多种实现方式，根据具体场景和需求来选择实施方式。例如，可以在单一托管模式中引入SPV技术来提高安全性和性能；或者在联盟模式中引入驱动链的机制来提高主链与侧链的互操作性。混合模式可以灵活地根据需求来选择最合适的方案实现。

![img](https://gitee.com/kkostar/pic/raw/master/4ssp8loft4.jpeg)	



## 优点

- 互操作性：侧链允许不同的区块链之间进行价值和数据的传输，促进了不同区块链网络之间的互操作性。
- 扩展性：侧链可以帮助解决主链上的交易处理能力限制问题，通过将复杂的交易转移到侧链上进行处理，可以提高整个系统的吞吐量。
- 定制性：侧链可以根据需求进行定制，可以选择不同的共识算法、数据结构和运行环境，以适应不同的应用场景和需求。
- 隐私性：侧链可以提供更好的隐私保护，通过将特定的交易移至侧链上进行处理，可以减少在主链上的敏感数据暴露的风险。

## 缺点

- 安全性风险：侧链相对于主链存在一定的安全风险，如果侧链的安全机制不够完善，可能会导致用户资产的丢失；同时侧链的安全性高度依赖于主链，如果主链被攻击或出现故障，侧链的安全也会受到威胁。
- 中心化风险：一些侧链可能会依赖中心化的节点或管理机构，这可能导致侧链的中心化风险增加。
- 跨链成本：跨链通信的实现存在一定的成本和复杂性，并且可能对整体性能产生影响，同时在侧链和主链之间进行价值和数据的转移可能涉及一定的手续费和时间成本。

## Quiz

1. 什么是侧链？
2. 侧链的出现是为了解决什么问题？
3. 侧链和主链之间如何进行交互？
4. 侧链有哪些优点？可能存在的安全风险有哪些？

# Plasma

## 简介

​		早期的状态通道（State Channels）和侧链(Sidechain)方案为区块链主链扩容问题提供了初步的解决思路，但也带来了新的问题。尽管状态通道为Layer1提高了吞吐量，但是该方案要求用户频繁在线并锁定资金，限制了资金的流动性，且难以处理大规模资金转移。侧链是一条独立的区块链，拥有自定义的共识机制、数据结构、社区运营模式，设计架构像是一个第三方交易所，允许用户在主链与侧链间转移资产，而后在侧链上完成交易，从而降低用户交易成本，替主链分担交易量。虽然侧链可以处理更大额的交易，但其本质上还是需要信任侧链运营商，这与区块链去中心化的理念背道而驰，为了让侧链去中心化，有学者提出将侧链的状态以某种形式存放在主网上供各用户监督，尝试通过这种方式削弱侧链的中心化属性。

​	    于是，Plasma 技术应运而生。在 Plasma 方案中，资金首先在主链（Layer 1）上通过智能合约被“锁定”。这种锁定类似于在传统银行存款：资金虽然存入，但暂时不进行任何处理，保持其安全性和不变性。接着，这些资金的代表（representation）会在 Plasma 链（Layer 2）上被创建和使用。

​		在 Layer 2 上，用户可以进行各种交易和操作，就像在主链上一样，但速度更快且成本更低。这是因为 Layer 2 的交易不需要即时在整个以太坊网络中广播和确认，从而大大减少了处理时间和手续费。交易完成后，Plasma 链会定期将这些交易的最终状态（或称为“状态快照”）汇总，并将其作为一个证明提交回主链。这样，主链就能够跟踪 Layer 2 的活动，同时保持整体网络的安全性和一致性。

​		通过这种方式，Plasma 实现了在 Layer 2 上更高效的资金流动和交易处理，同时又通过主链的智能合约保障了资金的安全性和不变性。这种分层的处理机制大大提高了以太坊网络的扩展性，同时减轻了主链的负担。

## 实现原理

### 资产转移

​		Plasma在主网（以太坊）上部署了智能合约，用户可以将资产转移到Plasma在以太坊上的指定地址，而后Plasma会铸造等价的替代代币。当用户从Plasma提取资产时，Plasma将销毁先前铸造的代币，而后在主网上向用户释放对应的资产。此处铸造、销毁是因为无法将资产在物理意义上进行跨链转移，因此通过主链锁仓、侧链铸造销毁的方式在逻辑上实现资产跨链。

### 状态提交

​		为了削弱侧链的中心化属性，Plasma提出将每条侧链的区块头放到主链上，一方面可供用户验证执行执行结果的正确性，另一方面依靠主链的安全性，可作为安全储备。但区块头对于主链来说仍然太大了，因此为了减少在主链上的存储空间，Plasma使用默克尔根来代表各区块中各交易的状态。		
​		默克尔根不仅压缩了大量的交易，而且难以造假，用户可以通过计算该区块所有交易的状态推算出提交的默克尔根是否正确。只有两棵默克尔树的叶子节点存储信息完全一致时，该两棵树的默克尔根才会一致。同时，默克尔根可以通过节点的哈希值和下载相关节点的哈希值来快速验证某个元素是否在一个集合中，同理，用户可以生成一个默克尔根证明证明交易包含在特定区块。

![在这里插入图片描述](https://gitee.com/kkostar/pic/raw/master/64e1a500fd584901b96140b96632819a.png)

​		当Plasma链执行完新的交易时，会产生新的状态，此时父链保存的状态根（默克尔根）也将随之改变，用户可以将在Plasma链上下载的交易信息在EVM虚拟机（侧链用的虚拟机一般与主链一致）中计算，比对父链中保存的状态根是否正确。		

### 欺诈证明

​		当侧链产生恶意区块时，用户缺乏反制手段，而Plasma给出对应的解决方案是在其父链上存储状态根，用户通过欺诈证明阻止侧链运营商产生恶意区块。任何用户在监控侧链并发现恶意区块时，都可以向其父链提交含默克尔根的欺诈证明，而后恶意区块将被回滚，恶意区块的生产者将被惩罚。

​		当用户从侧链提现资产到主链时，同样需要使用包含默克尔根的请求。用户向主链的Plasma合约发出提款请求，合约检查用户要提取的资产是否存在，即在指定区块的指定交易内是否有该用户的未使用输出。此处设计是为了防止恶意用户提出虚假的请求，但恶意用户仍有可能制作虚假的证据向合约证明，由于主链无法主动获取链下信息，只能验证默克尔根是否计算正确却无法验证证明真假，因此引入了“挑战期”机制。在“挑战期”内（一般为一周），任何人都可以构造欺诈证明来挑战提款请求。无论是区块生产者、提款人、挑战者在做出动作之前都需要锁定一定的保证金，挑战/守擂成功的一方将获得奖励，挑战/守擂失败的一方将扣除部分保证金。
​		若在挑战期内无人提供欺诈证明，则侧链的区块将永久生效，不再回滚。同理，提款请求也将通过，Plasma合约允许用户取回资产。

## 优缺点

​		Plasma与侧链同作为Layer2的技术方案，同样具备互操作性、扩展性、定制性、隐私性等优点。

​		而在安全性方面，用户们需要周期性的观察主网上的状态根是否正确，只要网络中拥有一个诚实的且在观察的用户即可保证状态根的正确，也即Plasma的安全。但是同样的，由于用户需要监控和验证链上交易，增加了Plasma链的很大开销。

​		另一方面，Plasma提款时间较长，当用户试图从Plasma提出资金时，必须要提出交易，然后等待一段挑战期结束后才能提取资金（虽然也可以通过流动性池来快速提款，但可能需要花费较高的手续费）。

​		于是以太坊开发者们站到Plasma的肩膀上继续探索，就出现了rollup的概念，直接将交易和数据拆开，一条链就负责交易，另一条链负责数据，将侧链交易数据直接发布到主链上，并提出了zk-Rollup来完全避免Plasma退出踩踏和挑战期的问题，但众所周知ZK技术的难度使得一直难以大众化落地。。

## Quiz

1. 什么是Plasma？
2. 默克尔树的主要作用是什么？
3. Plasma有哪些优缺点？

​	